Massive rewrite, see other branch for working copy. Ya I know why am i changing master.